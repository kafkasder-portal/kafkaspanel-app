import{j as e}from"./ui-vendor-B8g4ebjc.js";import{r as a}from"./react-vendor-DCtPEfzS.js";import{s as t,k as s,l as r,w as n,a as l,v as i,p as d,i as c,x as o,X as m,E as u,m as x}from"./auth-aCCa6xWs.js";import{e as h,D as p}from"./donations-DMDPGCBk.js";import{M as b}from"./messages-BBXjWSN2.js";import{S as g}from"./aid-DeFRiBQl.js";import{u as j,b as f,s as y,n as N}from"./form-vendor-CfNvelWt.js";import{V as v,t as w}from"./meetings-BPsEwMw_.js";import"./state-vendor-rPBjJaR_.js";import"./supabase-vendor-AMUhAiAi.js";import"./file-vendor-D5NpndWQ.js";import"./utils-vendor-DxpoukG0.js";import"./chart-vendor-CNXqmhrW.js";import"./dashboard-xaTgABQW.js";const k=f({beneficiary_id:y().min(1,"İhtiyaç sahibi seçiniz"),aid_record_id:y().min(1,"Yardım kaydı seçiniz"),amount:N().min(1,"Tutar giriniz"),bank_name:y().min(1,"Banka adı giriniz"),account_number:y().min(1,"Hesap numarası giriniz"),account_holder:y().min(1,"Hesap sahibi giriniz"),iban:y().min(26,"Geçerli IBAN giriniz").max(34),notes:y().optional()});function _(){const[f,y]=a.useState([]),[N,_]=a.useState({totalPending:0,totalSent:0,totalCompleted:0,totalAmount:0}),[S,C]=a.useState(!0),[B,T]=a.useState(""),[D,E]=a.useState("all"),[z,L]=a.useState("all"),[A,G]=a.useState(!1),[Y,H]=a.useState(!1),[q,R]=a.useState([]),[$,I]=a.useState([]),[M,F]=a.useState([]),{register:P,handleSubmit:O,formState:{errors:K},reset:V,watch:J}=j({resolver:w(k)}),Q=J("beneficiary_id");a.useEffect(()=>{U(),W(),X()},[]),a.useEffect(()=>{Q&&Z(Q)},[Q]);const U=async()=>{try{const{data:e,error:a}=await t.from("payments").select("\n          *,\n          beneficiaries (\n            name,\n            surname,\n            phone,\n            category\n          ),\n          aid_records (\n            aid_type,\n            amount,\n            notes\n          )\n        ").eq("payment_method","bank_transfer").order("created_at",{ascending:!1});if(a)throw a;y(e||[])}catch(e){v.error("Banka emirleri yüklenirken hata oluştu")}finally{C(!1)}},W=async()=>{try{const{data:e}=await t.from("payments").select("status, amount").eq("payment_method","bank_transfer");if(e){const a=e.filter(e=>"pending"===e.status).length,t=e.filter(e=>"sent"===e.status).length,s=e.filter(e=>"completed"===e.status).length,r=e.reduce((e,a)=>e+(a.amount||0),0);_({totalPending:a,totalSent:t,totalCompleted:s,totalAmount:r})}}catch(e){}},X=async()=>{try{const{data:e,error:a}=await t.from("beneficiaries").select("id, name, surname, category").eq("status","active").order("name");if(a)throw a;I(e||[])}catch(e){}},Z=async e=>{try{const{data:a,error:s}=await t.from("aid_records").select("id, aid_type, amount, notes").eq("beneficiary_id",e).eq("status","approved").order("created_at",{ascending:!1});if(s)throw s;F(a||[])}catch(a){}},ee=a.useMemo(()=>f.filter(e=>{const a=""===B||`${e.beneficiaries?.name} ${e.beneficiaries?.surname}`.toLowerCase().includes(B.toLowerCase())||e.account_holder.toLowerCase().includes(B.toLowerCase())||e.bank_name.toLowerCase().includes(B.toLowerCase())||e.transaction_ref?.toLowerCase().includes(B.toLowerCase()),t="all"===D||e.status===D;let s=!0;if("all"!==z){const a=new Date(e.order_date),t=new Date;switch(z){case"today":s=a.toDateString()===t.toDateString();break;case"week":s=a>=new Date(t.getTime()-6048e5);break;case"month":s=a.getMonth()===t.getMonth()&&a.getFullYear()===t.getFullYear()}}return a&&t&&s}),[f,B,D,z]),ae=e=>new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(e),te=e=>new Date(e).toLocaleDateString("tr-TR"),se=f.filter(e=>"pending"===e.status),re=[{key:"beneficiaries",header:"İhtiyaç Sahibi",render:(a,t)=>e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[t.beneficiaries?.name," ",t.beneficiaries?.surname]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:t.beneficiaries?.category})]})},{key:"amount",header:"Tutar",render:(a,t)=>e.jsx("div",{className:"font-medium text-green-600",children:ae(t.amount)})},{key:"bank_info",header:"Banka Bilgileri",render:(a,t)=>{return e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.bank_name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:t.account_holder}),e.jsx("div",{className:"text-xs text-muted-foreground",children:(s=t.iban,s.replace(/(.{4})/g,"$1 ").trim())})]});var s}},{key:"status",header:"Durum",render:(a,t)=>(a=>{const t={pending:{label:"Beklemede",class:"bg-yellow-100 text-yellow-800",icon:n},sent:{label:"Gönderildi",class:"bg-blue-100 text-blue-800",icon:s},completed:{label:"Tamamlandı",class:"bg-green-100 text-green-800",icon:l},failed:{label:"Başarısız",class:"bg-red-100 text-red-800",icon:m},cancelled:{label:"İptal Edildi",class:"bg-gray-100 text-gray-800",icon:m}}[a]||{label:a,class:"bg-gray-100 text-gray-800",icon:o},r=t.icon;return e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ${t.class}`,children:[e.jsx(r,{className:"h-3 w-3"}),t.label]})})(t.status)},{key:"order_date",header:"Emir Tarihi",render:(e,a)=>te(a.order_date)},{key:"sent_date",header:"Gönderim Tarihi",render:(e,a)=>a.sent_date?te(a.sent_date):"-"},{key:"transaction_ref",header:"İşlem Ref.",render:(a,t)=>e.jsx("div",{className:"max-w-xs truncate",title:t.transaction_ref,children:t.transaction_ref||"-"})},{key:"actions",header:"İşlemler",render:(a,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"rounded p-1 text-gray-600 hover:bg-gray-50",title:"Detay",children:e.jsx(u,{className:"h-4 w-4"})}),"pending"===t.status&&e.jsx("button",{className:"rounded p-1 text-blue-600 hover:bg-blue-50",title:"Düzenle",children:e.jsx(x,{className:"h-4 w-4"})})]})}];return S?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Yükleniyor..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Banka Ödeme Emirleri"}),e.jsx("p",{className:"text-muted-foreground",children:"Banka havalesi ile yapılacak ödemeleri yönetin"})]}),e.jsxs("div",{className:"flex gap-2",children:[se.length>0&&e.jsxs("button",{onClick:()=>{R(se),H(!0)},className:"flex items-center gap-2 rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700",children:[e.jsx(s,{className:"h-4 w-4"}),"Toplu Gönder (",se.length,")"]}),e.jsxs("button",{onClick:()=>G(!0),className:"flex items-center gap-2 rounded bg-primary px-4 py-2 text-sm text-white hover:bg-primary/90",children:[e.jsx(r,{className:"h-4 w-4"}),"Yeni Emir"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(g,{title:"Bekleyen Emirler",value:N.totalPending.toString(),icon:n,accentClass:"bg-yellow-100"}),e.jsx(g,{title:"Gönderilen Emirler",value:N.totalSent.toString(),icon:s,accentClass:"bg-blue-100"}),e.jsx(g,{title:"Tamamlanan Emirler",value:N.totalCompleted.toString(),icon:l,accentClass:"bg-green-100"}),e.jsx(g,{title:"Toplam Tutar",value:ae(N.totalAmount),icon:i,accentClass:"bg-purple-100"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 rounded-lg border p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(d,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("input",{type:"text",placeholder:"Emir ara...",value:B,onChange:e=>T(e.target.value),className:"min-w-64 rounded border px-3 py-2 text-sm"})]}),e.jsxs("select",{value:D,onChange:e=>E(e.target.value),className:"rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"Tüm Durumlar"}),e.jsx("option",{value:"pending",children:"Bekleyen"}),e.jsx("option",{value:"sent",children:"Gönderilen"}),e.jsx("option",{value:"completed",children:"Tamamlanan"}),e.jsx("option",{value:"failed",children:"Başarısız"}),e.jsx("option",{value:"cancelled",children:"İptal Edilen"})]}),e.jsxs("select",{value:z,onChange:e=>L(e.target.value),className:"rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"Tüm Tarihler"}),e.jsx("option",{value:"today",children:"Bugün"}),e.jsx("option",{value:"week",children:"Bu Hafta"}),e.jsx("option",{value:"month",children:"Bu Ay"})]}),e.jsxs("button",{onClick:()=>h("banka-odeme-emirleri.csv",ee),className:"flex items-center gap-2 rounded bg-green-600 px-3 py-2 text-sm text-white hover:bg-green-700",children:[e.jsx(c,{className:"h-4 w-4"}),"İndir"]}),e.jsxs("div",{className:"ml-auto text-sm text-muted-foreground",children:[ee.length," emir"]})]}),e.jsx(p,{columns:re,data:ee}),e.jsxs(b,{open:A,onClose:()=>G(!1),children:[e.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Yeni Banka Ödeme Emri"}),e.jsx("button",{onClick:()=>G(!1),className:"h-8 w-8 rounded-full bg-red-600 text-white hover:bg-red-700",children:"×"})]}),e.jsxs("form",{onSubmit:O(async e=>{try{const{error:a}=await t.from("payments").insert({aid_record_id:e.aid_record_id,beneficiary_id:e.beneficiary_id,payment_method:"bank_transfer",amount:e.amount,bank_account:e.iban,bank_name:e.bank_name,account_number:e.account_number,account_holder:e.account_holder,status:"pending",notes:e.notes});if(a)throw a;v.success("Banka ödeme emri başarıyla oluşturuldu"),G(!1),V(),U(),W()}catch(a){v.error("Banka ödeme emri oluşturulurken hata oluştu")}}),className:"p-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"İhtiyaç Sahibi *"}),e.jsxs("select",{...P("beneficiary_id"),className:"w-full rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"Seçiniz..."}),$.map(a=>e.jsxs("option",{value:a.id,children:[a.name," ",a.surname," - ",a.category]},a.id))]}),K.beneficiary_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:K.beneficiary_id.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Yardım Kaydı *"}),e.jsxs("select",{...P("aid_record_id"),className:"w-full rounded border px-3 py-2 text-sm",disabled:!Q,children:[e.jsx("option",{value:"",children:"Seçiniz..."}),M.map(a=>e.jsxs("option",{value:a.id,children:[a.aid_type," - ",ae(a.amount)]},a.id))]}),K.aid_record_id&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:K.aid_record_id.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Tutar *"}),e.jsx("input",{type:"number",step:"0.01",...P("amount",{valueAsNumber:!0}),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"0.00"}),K.amount&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:K.amount.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Banka Adı *"}),e.jsx("input",{type:"text",...P("bank_name"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Banka adı"}),K.bank_name&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:K.bank_name.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Hesap Sahibi *"}),e.jsx("input",{type:"text",...P("account_holder"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Hesap sahibinin adı"}),K.account_holder&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:K.account_holder.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Hesap Numarası *"}),e.jsx("input",{type:"text",...P("account_number"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Hesap numarası"}),K.account_number&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:K.account_number.message})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"IBAN *"}),e.jsx("input",{type:"text",...P("iban"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"TR00 0000 0000 0000 0000 0000 00",maxLength:34}),K.iban&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:K.iban.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notlar"}),e.jsx("textarea",{...P("notes"),rows:3,className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Ödeme emri ile ilgili notlar..."})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>G(!1),className:"rounded border px-4 py-2 text-sm hover:bg-gray-50",children:"İptal"}),e.jsxs("button",{type:"submit",className:"flex items-center gap-2 rounded bg-primary px-4 py-2 text-sm text-white hover:bg-primary/90",children:[e.jsx(r,{className:"h-4 w-4"}),"Oluştur"]})]})]})]}),e.jsxs(b,{open:Y,onClose:()=>H(!1),children:[e.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Toplu Banka Ödeme Emri Gönderimi"}),e.jsx("button",{onClick:()=>H(!1),className:"h-8 w-8 rounded-full bg-red-600 text-white hover:bg-red-700",children:"×"})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"rounded border p-4 bg-yellow-50",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(o,{className:"h-5 w-5 text-yellow-600"}),e.jsx("h3",{className:"font-medium text-yellow-800",children:"Dikkat"})]}),e.jsxs("p",{className:"text-sm text-yellow-700",children:[q.length," adet banka ödeme emri gönderilecek. Bu işlem geri alınamaz."]})]}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-2",children:"İhtiyaç Sahibi"}),e.jsx("th",{className:"text-left p-2",children:"Tutar"}),e.jsx("th",{className:"text-left p-2",children:"Banka"})]})}),e.jsx("tbody",{children:q.map(a=>e.jsxs("tr",{className:"border-b",children:[e.jsxs("td",{className:"p-2",children:[a.beneficiaries?.name," ",a.beneficiaries?.surname]}),e.jsx("td",{className:"p-2",children:ae(a.amount)}),e.jsx("td",{className:"p-2",children:a.bank_name})]},a.id))})]})}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{onClick:()=>H(!1),className:"rounded border px-4 py-2 text-sm hover:bg-gray-50",children:"İptal"}),e.jsxs("button",{onClick:async()=>{try{const e=q.map(e=>e.id),{error:a}=await t.from("payments").update({status:"sent",sent_date:(new Date).toISOString()}).in("id",e);if(a)throw a;v.success(`${q.length} adet banka ödeme emri gönderildi`),H(!1),R([]),U(),W()}catch(e){v.error("Banka emirleri gönderilirken hata oluştu")}},className:"flex items-center gap-2 rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700",children:[e.jsx(s,{className:"h-4 w-4"}),"Gönder"]})]})]})]})]})}export{_ as default};
