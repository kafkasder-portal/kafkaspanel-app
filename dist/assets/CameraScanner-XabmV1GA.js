import{j as e}from"./ui-vendor-B8g4ebjc.js";import{r as a}from"./react-vendor-DCtPEfzS.js";import{B as r,N as t,s}from"./ai-vendor-9_kz0VlM.js";import{bs as i,F as l,aX as n}from"./auth-DDWKT-vG.js";import"./state-vendor-rPBjJaR_.js";import"./supabase-vendor-AMUhAiAi.js";import"./file-vendor-D5NpndWQ.js";import"./utils-vendor-DxpoukG0.js";const o=({onScanResult:t,onError:o,mode:d="qr"})=>{const[c,m]=a.useState(!1),[u,h]=a.useState(null),[b,x]=a.useState(null),[p,g]=a.useState(0),[f,y]=a.useState(d),j=a.useRef(null),N=a.useRef(null),v=a.useRef(null),w=a.useRef(null),k=a.useRef(null),R=a.useCallback(async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return x(!1),h("Tarayıcınız kamera erişimini desteklemiyor"),void o?.("Tarayıcınız kamera erişimini desteklemiyor");const e=await navigator.mediaDevices.getUserMedia({video:!0});x(!0),e.getTracks().forEach(e=>{e.stop()})}catch(e){x(!1);const a=e instanceof Error?e.message:"Kamera erişim izni gerekli";h(`Kamera erişim hatası: ${a}`),o?.(`Kamera erişim hatası: ${a}`)}},[o]),D=async()=>{if(j.current&&N.current)try{g(0),h(null);const i=N.current,l=i.getContext("2d");if(!l)return void h("Canvas hatası");if(0===j.current.videoWidth||0===j.current.videoHeight)return void h("Video henüz yüklenmedi");i.width=j.current.videoWidth,i.height=j.current.videoHeight,l.drawImage(j.current,0,0);let n=k.current;if(!n)try{n=await s.createWorker(),k.current=n}catch(e){return h("OCR motoru başlatılamadı"),void o?.("OCR motoru başlatılamadı")}try{await n.load(),await n.reinitialize("tur+eng")}catch(a){if(k.current){try{await k.current.terminate()}catch(r){}k.current=null}return h("OCR sistemi başlatılamadı"),void o?.("OCR sistemi başlatılamadı")}const{data:{text:d}}=await n.recognize(i);if(d.trim()){const e=(e=>{const a=e.split("\n").map(e=>e.trim()).filter(e=>e.length>0),r={};if(0===a.length)return{type:"ocr",data:e,parsedData:r};const t=/\b\d{11}\b/g,s=/^[A-ZÇĞIİÖŞÜ][a-zçğıiöşü]+\s+[A-ZÇĞIİÖŞÜ][a-zçğıiöşü]+/,i=/(\d{1,2})[./-](\d{1,2})[./-](\d{4})/g,l=/(ADRES|ADRESİ|ADDRESS)\s*:?\s*(.+)/i,n=/(\+90|0)?\s*[5][0-9]{2}\s*[0-9]{3}\s*[0-9]{2}\s*[0-9]{2}/g;for(let d=0;d<a.length;d++){const e=a[d],o=[...e.matchAll(t)];if(o.length>0&&!r.idNumber&&(r.idNumber=o[0][0],r.donorId=`TC${o[0][0]}`),!r.firstName&&!r.lastName){const a=/^[A-ZÇĞIİÖŞÜ\s]{3,}$/;if(e.match(a)&&e.split(" ").length>=2){const a=e.split(" ").filter(e=>e.length>1);a.length>=2&&(r.firstName=a[0],r.lastName=a.slice(1).join(" "),r.donorName=e)}const t=e.match(s);if(t){const e=t[0].split(" ");r.firstName=e[0],e.length>1&&(r.lastName=e.slice(1).join(" ")),r.donorName=t[0]}}const c=[...e.matchAll(i)];if(c.length>0&&!r.birthDate){const e=c[0],a=e[1].padStart(2,"0"),t=e[2].padStart(2,"0"),s=e[3];r.birthDate=`${s}-${t}-${a}`}const m=e.match(l);m&&!r.address&&(r.address=m[2].trim());const u=[...e.matchAll(n)];u.length>0&&!r.phone&&(r.phone=u[0][0].replace(/\s/g,"")),e.length>20&&e.match(/[A-ZÇĞIİÖŞÜ][a-zçğıiöşü]+.*[A-ZÇĞIİÖŞÜ][a-zçğıiöşü]+/)&&(r.address||(r.address=e))}const o=/P<[A-Z]{3}[A-Z<]+<+[A-Z0-9<]+/;for(const d of a){if(d.match(o)){const e=d.split("<");if(e.length>1){const a=e[1].replace(/</g," ").trim();if(a&&!r.firstName){const e=a.split(" ").filter(e=>e.length>0);e.length>0&&(r.firstName=e[0],e.length>1&&(r.lastName=e.slice(1).join(" ")),r.donorName=`${r.firstName} ${r.lastName||""}`.trim())}}}const e=d.match(/\b([A-Z]\d{8})\b/);e&&(r.passportNumber=e[1],r.donorId=`PASS${e[1]}`);const a=d.match(/\b(\d{2}[./]\d{2}[./]\d{4})\b/g);a&&a.length>=2&&(r.issueDate=a[0],r.expiryDate=a[1]),d.match(/TUR|TURKEY|TÜRKİYE/i)&&(r.nationality="Türkiye")}return{type:"ocr",data:e,parsedData:r}})(d);t(e.parsedData||{rawData:e.data}),g(100),setTimeout(()=>g(0),1e3)}else h("Metin algılanamadı. Lütfen belgeyi daha net konumlandırın.")}catch(i){h(`OCR işlemi başarısız oldu: ${i instanceof Error?i.message:"Bilinmeyen hata"}`),o?.(`OCR işlemi başarısız oldu: ${i instanceof Error?i.message:"Bilinmeyen hata"}`),g(0)}else h("Kamera hazır değil")},T=a.useCallback(async()=>{if(j.current)if(b)try{m(!0),h(null);const e={video:{facingMode:"environment",width:{ideal:1280,min:640},height:{ideal:720,min:480}}},a=await navigator.mediaDevices.getUserMedia(e);if(w.current=a,j.current.srcObject=a,await new Promise((e,a)=>{const r=j.current,t=setTimeout(()=>{a(new Error("Video yükleme timeout"))},1e4);r.onloadedmetadata=()=>{clearTimeout(t),e(void 0)},r.onerror=e=>{clearTimeout(t),a(new Error("Video yüklenemedi"))}}),"qr"===f){v.current=new r;const e=async()=>{if(v.current&&j.current&&c)try{const e=await v.current.decodeOnceFromVideoDevice(void 0,j.current);if(e){const a=(e=>{try{const a=JSON.parse(e);return{type:"qr",data:e,parsedData:{donorId:a.donorId,transactionRef:a.transactionRef||a.ref,amount:a.amount,currency:a.currency||"TRY",donorName:a.donorName||a.name,phone:a.phone,email:a.email,purpose:a.purpose}}}catch{if(e.match(/^REF\d+$/))return{type:"barcode",data:e,parsedData:{transactionRef:e}};if(e.match(/^DONOR\d+$/))return{type:"barcode",data:e,parsedData:{donorId:e}};if(e.match(/^\+?[0-9]{10,15}$/))return{type:"barcode",data:e,parsedData:{phone:e}};if(e.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/))return{type:"barcode",data:e,parsedData:{email:e}};const a=e.match(/^(\d+(?:\.\d{2})?)([A-Z]{3})$/);return a?{type:"barcode",data:e,parsedData:{amount:a[1],currency:a[2]}}:{type:"unknown",data:e}}})(e.getText());t(a.parsedData||{rawData:a.data}),C()}}catch(a){c&&setTimeout(e,100)}};e()}}catch(e){const a=e instanceof Error?e.message:"Bilinmeyen hata";h(`Kamera başlatılamadı: ${a}`),o?.(`Kamera başlatılamadı: ${a}`),m(!1)}else h("Kamera izni gerekli");else h("Video elementi hazır değil")},[f,b,c,t,o]),C=()=>{if(m(!1),g(0),w.current&&(w.current.getTracks().forEach((e,a)=>{e.stop()}),w.current=null),j.current&&(j.current.srcObject=null,j.current.onloadedmetadata=null,j.current.onerror=null),v.current)try{v.current.reset()}catch(e){}finally{v.current=null}};return a.useEffect(()=>(R(),()=>{if(C(),k.current)try{k.current.terminate()}catch(e){}finally{k.current=null}}),[R]),a.useEffect(()=>{b&&!c&&T()},[b,c,T]),e.jsxs("div",{className:"bg-gray-50 border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:["qr"===f?e.jsx(i,{className:"w-5 h-5"}):e.jsx(l,{className:"w-5 h-5"}),"qr"===f?"QR Kod / Barkod Tara":"Kimlik / Pasaport OCR"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>{y("qr")},className:"px-3 py-1 text-sm rounded "+("qr"===f?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"),children:[e.jsx(i,{className:"w-4 h-4 inline mr-1"}),"QR/Barkod"]}),e.jsxs("button",{onClick:()=>{y("ocr")},className:"px-3 py-1 text-sm rounded "+("ocr"===f?"bg-blue-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"),children:[e.jsx(l,{className:"w-4 h-4 inline mr-1"}),"Kimlik/Pasaport"]})]})]}),null===b&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(n,{className:"w-12 h-12 mx-auto text-gray-400 mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Kamera izni kontrol ediliyor..."})]}),!1===b&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(n,{className:"w-12 h-12 mx-auto text-red-400 mb-4"}),e.jsx("p",{className:"text-red-600 mb-4",children:"Kamera erişim izni gerekli"}),e.jsx("button",{onClick:R,className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",children:"Tekrar Dene"})]}),!0===b&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative bg-black rounded-lg overflow-hidden",children:[e.jsx("video",{ref:j,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-64 object-cover"}),e.jsx("canvas",{ref:N,className:"hidden"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:"qr"===f?e.jsx("div",{className:"w-48 h-48 border-2 border-white border-dashed rounded-lg opacity-75"}):e.jsx("div",{className:"w-64 h-40 border-2 border-yellow-400 border-solid rounded-lg opacity-75",children:e.jsx("div",{className:"absolute -top-6 left-0 text-yellow-400 text-sm font-medium",children:"Kimlik/Pasaport buraya yerleştirin"})})}),e.jsx("div",{className:"absolute top-4 left-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded",children:"qr"===f?c?"Taranıyor...":"Hazır":p>0?`OCR İşleniyor... %${p}`:"OCR Hazır"}),"ocr"===f&&c&&e.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2",children:e.jsxs("button",{onClick:D,disabled:p>0,className:"bg-yellow-500 hover:bg-yellow-600 disabled:opacity-50 text-white px-6 py-3 rounded-full font-medium flex items-center gap-2",children:[e.jsx(n,{className:"w-5 h-5"}),"Fotoğraf Çek ve Oku"]})})]}),u&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded",children:["❌ ",u]}),c&&!u&&0===p&&e.jsxs("div",{className:"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded",children:["✅ ","qr"===f?"QR/Barkod taranıyor...":"Kamera hazır - Fotoğraf çekmek için butona basın"]}),p>0&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded",children:["🔄 OCR işleniyor... ",p,"%",e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 mt-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${p}%`}})})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("p",{className:"mb-2",children:e.jsx("strong",{children:"Desteklenen formatlar:"})}),"qr"===f?e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[e.jsx("li",{children:"QR kodlar (JSON veri içeren)"}),e.jsx("li",{children:"Banka referans numaraları (REF123456)"}),e.jsx("li",{children:"Bağışçı ID'leri (DONOR123456)"}),e.jsx("li",{children:"Telefon numaraları"}),e.jsx("li",{children:"E-posta adresleri"}),e.jsx("li",{children:"Tutar bilgileri (1000TRY)"})]}):e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[e.jsx("li",{children:"Türk Kimlik Kartı (TC No, Ad Soyad, Doğum Tarihi)"}),e.jsx("li",{children:"Türk Pasaportu (Pasaport No, Kişisel Bilgiler)"}),e.jsx("li",{children:"Adres bilgileri"}),e.jsx("li",{children:"Telefon numaraları"}),e.jsx("li",{children:"Veriliş ve son geçerlilik tarihleri"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{C()},disabled:!c,className:"flex-1 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 disabled:opacity-50",children:"Durdur"}),e.jsx("button",{onClick:()=>{T()},disabled:c||p>0,className:"flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50",children:"qr"===f?"QR Tarama Başlat":"Kamera Başlat"}),"ocr"===f&&c&&e.jsx("button",{onClick:()=>{D()},disabled:p>0,className:"flex-1 bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 disabled:opacity-50",children:p>0?`OCR %${p}`:"OCR Tara"})]})]})]})};export{o as CameraScanner,o as default};
