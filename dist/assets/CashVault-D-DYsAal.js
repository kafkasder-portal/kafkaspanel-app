import{j as e}from"./ui-vendor-B8g4ebjc.js";import{r as a}from"./react-vendor-DCtPEfzS.js";import{s as t,a as s,T as r,al as n,d as i,p as l,i as d,v as o,X as c,E as m}from"./auth-CY9yrbMl.js";import{e as u,D as h}from"./donations-Cs-DOdlb.js";import{M as p}from"./messages-BdWFJ_-b.js";import{S as x}from"./aid-DdyBfUwd.js";import{u as b,b as j,s as y,e as g}from"./form-vendor-CfNvelWt.js";import{V as f,t as v}from"./meetings-CSL3uVn4.js";import"./state-vendor-rPBjJaR_.js";import"./supabase-vendor-AMUhAiAi.js";import"./file-vendor-D5NpndWQ.js";import"./utils-vendor-DxpoukG0.js";import"./chart-vendor-CNXqmhrW.js";import"./dashboard-DU4k1qlk.js";const N=j({payment_method:g(["cash","bank_transfer","check"],{message:"Ödeme yöntemi seçiniz"}),bank_account:y().optional(),transaction_ref:y().optional(),notes:y().optional()});function k(){const[j,y]=a.useState([]),[g,k]=a.useState({totalApproved:0,totalDistributed:0,pendingDistribution:0,monthlyTotal:0}),[w,_]=a.useState(!0),[D,S]=a.useState(""),[T,C]=a.useState("all"),[Y,B]=a.useState("all"),[O,q]=a.useState(!1),[L,R]=a.useState(null),{register:A,handleSubmit:E,formState:{errors:H},reset:I,watch:M}=b({resolver:v(N)}),$=M("payment_method");a.useEffect(()=>{z(),F()},[]);const z=async()=>{try{const{data:e,error:a}=await t.from("aid_records").select("\n          *,\n          beneficiaries (\n            name,\n            surname,\n            phone,\n            category\n          ),\n          payments (\n            id,\n            payment_method,\n            amount,\n            status,\n            paid_at\n          )\n        ").eq("aid_type","cash").order("created_at",{ascending:!1});if(a)throw a;y(e||[])}catch(e){f.error("Nakdi yardım kayıtları yüklenirken hata oluştu")}finally{_(!1)}},F=async()=>{try{const{data:e}=await t.from("aid_records").select("amount").eq("aid_type","cash").eq("status","approved"),a=e?.reduce((e,a)=>e+(a.amount||0),0)||0,{data:s}=await t.from("aid_records").select("amount").eq("aid_type","cash").in("status",["distributed","completed"]),r=s?.reduce((e,a)=>e+(a.amount||0),0)||0,n=a-r,i=(new Date).toISOString().slice(0,7),{data:l}=await t.from("aid_records").select("amount").eq("aid_type","cash").gte("created_at",`${i}-01`),d=l?.reduce((e,a)=>e+(a.amount||0),0)||0;k({totalApproved:a,totalDistributed:r,pendingDistribution:n,monthlyTotal:d})}catch(e){}},K=a.useMemo(()=>j.filter(e=>{const a=""===D||`${e.beneficiaries?.name} ${e.beneficiaries?.surname}`.toLowerCase().includes(D.toLowerCase())||e.notes?.toLowerCase().includes(D.toLowerCase()),t="all"===T||e.status===T;let s=!0;if("all"!==Y){const a=new Date(e.created_at),t=new Date;switch(Y){case"today":s=a.toDateString()===t.toDateString();break;case"week":s=a>=new Date(t.getTime()-6048e5);break;case"month":s=a.getMonth()===t.getMonth()&&a.getFullYear()===t.getFullYear()}}return a&&t&&s}),[j,D,T,Y]),V=e=>new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(e),G=e=>new Date(e).toLocaleDateString("tr-TR"),J=[{key:"beneficiaries",header:"İhtiyaç Sahibi",render:(a,t)=>e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[t.beneficiaries?.name," ",t.beneficiaries?.surname]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:t.beneficiaries?.category})]})},{key:"amount",header:"Tutar",render:(a,t)=>e.jsx("div",{className:"font-medium text-green-600",children:V(t.amount)})},{key:"status",header:"Durum",render:(a,t)=>(a=>{const t={approved:{label:"Onaylandı",class:"bg-green-100 text-green-800",icon:s},distributed:{label:"Dağıtıldı",class:"bg-blue-100 text-blue-800",icon:r},completed:{label:"Tamamlandı",class:"bg-purple-100 text-purple-800",icon:s},cancelled:{label:"İptal Edildi",class:"bg-red-100 text-red-800",icon:c}}[a]||{label:a,class:"bg-gray-100 text-gray-800",icon:s},n=t.icon;return e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ${t.class}`,children:[e.jsx(n,{className:"h-3 w-3"}),t.label]})})(t.status)},{key:"approved_at",header:"Onay Tarihi",render:(e,a)=>G(a.approved_at)},{key:"distributed_at",header:"Dağıtım Tarihi",render:(e,a)=>a.distributed_at?G(a.distributed_at):"-"},{key:"payments",header:"Ödeme Yöntemi",render:(e,a)=>{const t=a.payments?.[0];return t?{cash:"Nakit",bank_transfer:"Banka Havalesi",check:"Çek"}[s=t.payment_method]||s:"-";var s}},{key:"notes",header:"Notlar",render:(a,t)=>e.jsx("div",{className:"max-w-xs truncate",title:t.notes,children:t.notes||"-"})},{key:"actions",header:"İşlemler",render:(a,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:["approved"===t.status&&e.jsx("button",{onClick:()=>{R(t),q(!0)},className:"rounded p-1 text-blue-600 hover:bg-blue-50",title:"Dağıt",children:e.jsx(o,{className:"h-4 w-4"})}),e.jsx("button",{className:"rounded p-1 text-gray-600 hover:bg-gray-50",title:"Detay",children:e.jsx(m,{className:"h-4 w-4"})})]})}];return w?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Yükleniyor..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Nakdi Yardım Veznesi"}),e.jsx("p",{className:"text-muted-foreground",children:"Nakdi yardımları yönetin ve dağıtın"})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(x,{title:"Toplam Onaylanan",value:V(g.totalApproved),icon:s,accentClass:"bg-green-100"}),e.jsx(x,{title:"Toplam Dağıtılan",value:V(g.totalDistributed),icon:r,accentClass:"bg-blue-100"}),e.jsx(x,{title:"Dağıtım Bekleyen",value:V(g.pendingDistribution),icon:n,accentClass:"bg-orange-100"}),e.jsx(x,{title:"Bu Ay Toplam",value:V(g.monthlyTotal),icon:i,accentClass:"bg-purple-100"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 rounded-lg border p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(l,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("input",{type:"text",placeholder:"Kayıt ara...",value:D,onChange:e=>S(e.target.value),className:"min-w-64 rounded border px-3 py-2 text-sm"})]}),e.jsxs("select",{value:T,onChange:e=>C(e.target.value),className:"rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"Tüm Durumlar"}),e.jsx("option",{value:"approved",children:"Onaylanan"}),e.jsx("option",{value:"distributed",children:"Dağıtılan"}),e.jsx("option",{value:"completed",children:"Tamamlanan"}),e.jsx("option",{value:"cancelled",children:"İptal Edilen"})]}),e.jsxs("select",{value:Y,onChange:e=>B(e.target.value),className:"rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"Tüm Tarihler"}),e.jsx("option",{value:"today",children:"Bugün"}),e.jsx("option",{value:"week",children:"Bu Hafta"}),e.jsx("option",{value:"month",children:"Bu Ay"})]}),e.jsxs("button",{onClick:()=>u("nakdi-yardim-kayitlari.csv",K),className:"flex items-center gap-2 rounded bg-green-600 px-3 py-2 text-sm text-white hover:bg-green-700",children:[e.jsx(d,{className:"h-4 w-4"}),"İndir"]}),e.jsxs("div",{className:"ml-auto text-sm text-muted-foreground",children:[K.length," kayıt"]})]}),e.jsx(h,{columns:J,data:K}),e.jsxs(p,{open:O,onClose:()=>q(!1),children:[e.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Nakdi Yardım Dağıtımı"}),e.jsx("button",{onClick:()=>q(!1),className:"h-8 w-8 rounded-full bg-red-600 text-white hover:bg-red-700",children:"×"})]}),L&&e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"rounded border p-4 bg-gray-50",children:[e.jsx("h3",{className:"font-medium mb-2",children:"Yardım Detayları"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"İhtiyaç Sahibi:"})," ",L.beneficiaries?.name," ",L.beneficiaries?.surname]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Kategori:"})," ",L.beneficiaries?.category]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Tutar:"})," ",V(L.amount)]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Onay Tarihi:"})," ",(P=L.approved_at,new Date(P).toLocaleString("tr-TR"))]}),L.notes&&e.jsxs("div",{children:[e.jsx("strong",{children:"Notlar:"})," ",L.notes]})]})]}),e.jsxs("form",{onSubmit:E(async e=>{if(L)try{const{error:a}=await t.from("payments").insert({aid_record_id:L.id,payment_method:e.payment_method,amount:L.amount,bank_account:e.bank_account,transaction_ref:e.transaction_ref,status:"completed",paid_at:(new Date).toISOString(),notes:e.notes});if(a)throw a;const{error:s}=await t.from("aid_records").update({status:"distributed",distributed_at:(new Date).toISOString()}).eq("id",L.id);if(s)throw s;f.success("Nakdi yardım başarıyla dağıtıldı"),q(!1),R(null),I(),z(),F()}catch(a){f.error("Nakdi yardım dağıtılırken hata oluştu")}}),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Ödeme Yöntemi *"}),e.jsxs("select",{...A("payment_method"),className:"w-full rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"Seçiniz..."}),e.jsx("option",{value:"cash",children:"Nakit"}),e.jsx("option",{value:"bank_transfer",children:"Banka Havalesi"}),e.jsx("option",{value:"check",children:"Çek"})]}),H.payment_method&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:H.payment_method.message})]}),"bank_transfer"===$&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Banka Hesap No"}),e.jsx("input",{type:"text",...A("bank_account"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"TR00 0000 0000 0000 0000 0000 00"})]}),("bank_transfer"===$||"check"===$)&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"İşlem Referansı"}),e.jsx("input",{type:"text",...A("transaction_ref"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"İşlem numarası veya referans kodu"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notlar"}),e.jsx("textarea",{...A("notes"),rows:3,className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Dağıtım ile ilgili notlar..."})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>q(!1),className:"rounded border px-4 py-2 text-sm hover:bg-gray-50",children:"İptal"}),e.jsxs("button",{type:"submit",className:"flex items-center gap-2 rounded bg-green-600 px-4 py-2 text-sm text-white hover:bg-green-700",children:[e.jsx(o,{className:"h-4 w-4"}),"Dağıt"]})]})]})]})]})]});var P}export{k as default};
